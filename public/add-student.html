<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</title>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å -->
    <link rel="stylesheet" href="style.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@300;400;600&family=Segoe+UI:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <header>
            <!-- –°–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div id="user-section" class="user-section"></div>

            <h1><i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</h1>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</p>

            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </header>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="guest-info" class="edit-section" style="display: none;">
            <div class="edit-panel">
                <h3><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p class="edit-hint">
                    <i class="fas fa-sign-in-alt"></i>
                    –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.
                    <br>
                    <small>–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É.</small>
                </p>
                <div class="auth-buttons" style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="login-btn" onclick="window.studentSystem.showLoginModal()">
                        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                    </button>
                    <button class="register-btn" onclick="window.studentSystem.showRegisterModal()">
                        <i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
        <div id="add-form-section" class="add-form" style="display: none;">
            <h3><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>

            <div id="form-hint" style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 10px; border-left: 4px solid #3498db;">
                <small style="color: #666;">
                    <i class="fas fa-info-circle"></i>
                    <span id="hint-text">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</span>
                </small>
            </div>

            <form id="student-form">
                <div class="form-grid">
                    <!-- –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û -->
                    <div class="form-group full-width">
                        <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <div class="photo-upload-area" id="add-photo-upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>
                            <p><small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP (–¥–æ 5MB)</small></p>
                            <input type="file" id="add-photo-input" accept="image/*" style="display: none;">
                        </div>
                        <div id="add-photo-preview-container" style="margin-top: 15px;"></div>
                        <input type="hidden" id="add-photo-url" value="/images/default.jpg">
                    </div>

                    <div class="form-group">
                        <label>–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è *</label>
                        <input type="text" id="name" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required>
                    </div>

                    <div class="form-group full-width">
                        <label>–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ *</label>
                        <input type="text" id="institution" placeholder="–ö–æ–ª–ª–µ–¥–∂ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π ‚Ññ1" required>
                    </div>

                    <div class="form-group">
                        <label>–ö—É—Ä—Å *</label>
                        <select id="course" required>
                            <option value="1">1 –∫—É—Ä—Å</option>
                            <option value="2">2 –∫—É—Ä—Å</option>
                            <option value="3">3 –∫—É—Ä—Å</option>
                            <option value="4" selected>4 –∫—É—Ä—Å</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="status">
                            <option value="studying" selected>–û–±—É—á–∞–µ—Ç—Å—è</option>
                            <option value="graduated">–í—ã–ø—É—Å—Ç–∏–ª—Å—è</option>
                            <option value="expelled">–û—Ç—á–∏—Å–ª–µ–Ω</option>
                            <option value="academic_leave">–ê–∫–∞–¥–µ–º–æ—Ç–ø—É—Å–∫</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
                        <input type="text" id="description" placeholder="Backend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, —É–≤–ª–µ–∫–∞–µ—Ç—Å—è Python" required>
                    </div>

                    <div class="form-group full-width">
                        <label>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                        <textarea id="full-info" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å—Ç—É–¥–µ–Ω—Ç–µ..."></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label>–ù–∞–≤—ã–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                        <input type="text" id="skills" placeholder="Python, JavaScript, React, Docker">
                    </div>

                    <div class="form-group">
                        <label>GitHub (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="url" id="github" placeholder="https://github.com/username">
                    </div>

                    <div class="form-group">
                        <label>–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="url" id="portfolio" placeholder="https://myportfolio.com">
                    </div>
                </div>

                <div class="form-actions" style="display: flex; gap: 15px; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞
                    </button>
                </div>
            </form>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ –µ—Å—Ç—å -->
        <div id="already-have-card" class="edit-section" style="display: none;">
            <div class="edit-panel">
                <h3><i class="fas fa-user-check"></i> –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∞</h3>
                <div style="text-align: center; padding: 30px;">
                    <i class="fas fa-user-circle" style="font-size: 5rem; color: #3498db; margin-bottom: 20px;"></i>
                    <h4 style="color: #2d3436; margin-bottom: 15px;">–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞</h4>
                    <p style="color: #666; margin-bottom: 25px;">
                        –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É.<br>
                        –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" onclick="window.studentSystem.openEditMyCard()">
                            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ—é –∫–∞—Ä—Ç–æ—á–∫—É
                        </button>
                        <a href="/" class="btn btn-secondary">
                            <i class="fas fa-list"></i> –ö —Å–ø–∏—Å–∫—É —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
        <div id="admin-message" class="edit-section" style="display: none;">
            <div class="edit-panel">
                <h3><i class="fas fa-crown"></i> –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                <div style="text-align: center; padding: 30px;">
                    <i class="fas fa-user-shield" style="font-size: 5rem; color: #e74c3c; margin-bottom: 20px;"></i>
                    <h4 style="color: #2d3436; margin-bottom: 15px;">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h4>
                    <p style="color: #666; margin-bottom: 25px;">
                        –ö–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫.<br>
                        –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-list"></i> –ö —Å–ø–∏—Å–∫—É —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
                        </a>
                        <a href="/admin" class="btn btn-success">
                            <i class="fas fa-cogs"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="login-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                <button class="modal-close" onclick="window.studentSystem.closeModal('login-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <small style="color: #666; display: block; margin-bottom: 10px;">–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</small>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                        <div><strong>–ê–¥–º–∏–Ω:</strong> admin / admin123</div>
                        <div><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> student1 / student123</div>
                    </div>
                </div>
                <form id="modal-login-form">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω</label>
                        <input type="text" id="modal-username" required>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="modal-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.studentSystem.closeModal('login-modal')">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="register-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <button class="modal-close" onclick="window.studentSystem.closeModal('register-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="modal-register-form">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω *</label>
                        <input type="text" id="reg-username" required minlength="3">
                        <small style="display: block; margin-top: 5px; color: #666;">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</small>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å *</label>
                        <input type="password" id="reg-password" required minlength="6">
                        <small style="display: block; margin-top: 5px; color: #666;">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>
                    <div class="form-group">
                        <label>Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="email" id="reg-email">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.studentSystem.closeModal('register-modal')">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ -->
    <style>
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4091 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #009688 0%, #8bc34a 100%);
            transform: translateY(-2px);
        }
    </style>

    <!-- JavaScript –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <script>
        class AddStudentSystem {
            constructor() {
                this.currentUser = null;
                this.myStudentCard = null;
                this.init();
            }

            async init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞...');
                this.initEvents();
                await this.checkAuth();
            }

            async checkAuth() {
                try {
                    const response = await fetch('/api/current-user');
                    if (response.ok) {
                        this.currentUser = await response.json();
                        this.updateUserInfo();
                        await this.checkUserCard();
                    }
                } catch (error) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    this.showLoginSection();
                }
            }

            async checkUserCard() {
                if (!this.currentUser) return;

                try {
                    const response = await fetch('/api/check-card', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();

                        if (this.currentUser.role === 'admin') {
                            // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É
                            this.showAdminForm();
                        } else if (data.hasCard) {
                            // –£ —Å—Ç—É–¥–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∞
                            this.showAlreadyHaveCard();
                        } else {
                            // –°—Ç—É–¥–µ–Ω—Ç –±–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É
                            this.showAddForm();
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:', error);
                }
            }

            showLoginSection() {
                document.getElementById('guest-info').style.display = 'block';
                document.getElementById('add-form-section').style.display = 'none';
                document.getElementById('already-have-card').style.display = 'none';
                document.getElementById('admin-message').style.display = 'none';
            }

            showAddForm() {
                document.getElementById('guest-info').style.display = 'none';
                document.getElementById('add-form-section').style.display = 'block';
                document.getElementById('already-have-card').style.display = 'none';
                document.getElementById('admin-message').style.display = 'none';

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                const hintText = document.getElementById('hint-text');
                if (hintText) {
                    hintText.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞—à–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É.';
                }
            }

            showAlreadyHaveCard() {
                document.getElementById('guest-info').style.display = 'none';
                document.getElementById('add-form-section').style.display = 'none';
                document.getElementById('already-have-card').style.display = 'block';
                document.getElementById('admin-message').style.display = 'none';
            }

            showAdminForm() {
                document.getElementById('guest-info').style.display = 'none';
                document.getElementById('add-form-section').style.display = 'block';
                document.getElementById('already-have-card').style.display = 'none';
                document.getElementById('admin-message').style.display = 'none';

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –∞–¥–º–∏–Ω–∞
                const hintText = document.getElementById('hint-text');
                if (hintText) {
                    hintText.textContent = '–ö–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫.';
                }
            }

            updateUserInfo() {
                const userSection = document.getElementById('user-section');

                if (!userSection) return;

                if (this.currentUser) {
                    userSection.innerHTML = `
                        <div class="user-info">
                            <i class="fas fa-user-circle"></i>
                            <div class="user-details">
                                <strong>${this.currentUser.username}</strong>
                                <span class="user-role ${this.currentUser.role}">
                                    ${this.currentUser.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : 'üë®‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç'}
                                </span>
                            </div>
                            <button class="logout-btn" onclick="window.addStudentSystem.logout()">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    `;
                } else {
                    userSection.innerHTML = `
                        <div class="auth-buttons">
                            <button class="login-btn" onclick="window.addStudentSystem.showLoginModal()">
                                <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                            </button>
                            <button class="register-btn" onclick="window.addStudentSystem.showRegisterModal()">
                                <i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                        </div>
                    `;
                }
            }

            initEvents() {
                // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞
                const studentForm = document.getElementById('student-form');
                if (studentForm) {
                    studentForm.addEventListener('submit', (e) => this.addStudent(e));
                    this.initAddPhotoUpload();
                }

                // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        this.closeAllModals();
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            }

            initAddPhotoUpload() {
                const uploadArea = document.getElementById('add-photo-upload-area');
                const photoInput = document.getElementById('add-photo-input');

                if (!uploadArea || !photoInput) return;

                uploadArea.addEventListener('click', () => {
                    photoInput.click();
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#00b894';
                    uploadArea.style.background = 'rgba(0, 184, 148, 0.1)';
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.background = '#fafafa';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ddd';
                    uploadArea.style.background = '#fafafa';

                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.startsWith('image/')) {
                            photoInput.files = e.dataTransfer.files;
                            this.handleAddPhotoUpload(file);
                        } else {
                            this.showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                        }
                    }
                });

                photoInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleAddPhotoUpload(e.target.files[0]);
                    }
                });
            }

            async handleAddPhotoUpload(file) {
                try {
                    const previewContainer = document.getElementById('add-photo-preview-container');
                    const photoUrlInput = document.getElementById('add-photo-url');

                    if (file.size > 5 * 1024 * 1024) {
                        this.showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <img src="${e.target.result}" alt="–ü—Ä–µ–≤—å—é" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px;">
                                <div style="flex: 1;">
                                    <p style="margin: 0 0 5px 0; font-weight: bold;">${file.name}</p>
                                    <p style="margin: 0; color: #666; font-size: 0.9em;">${(file.size / 1024).toFixed(1)} KB</p>
                                </div>
                                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); document.getElementById('add-photo-url').value = '/images/default.jpg';" style="padding: 5px 10px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);

                    const formData = new FormData();
                    formData.append('photo', file);

                    const response = await fetch('/api/upload-photo', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        photoUrlInput.value = result.photoUrl;
                        this.showNotification('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
                    this.showNotification(error.message, 'error');
                    document.getElementById('add-photo-input').value = '';
                }
            }

            async addStudent(event) {
                event.preventDefault();

                const form = event.target;

                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    if (!this.currentUser) {
                        this.showNotification('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏', 'error');
                        this.showLoginModal();
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
                    if (this.currentUser.role !== 'admin') {
                        const checkResponse = await fetch('/api/check-card', {
                            credentials: 'include'
                        });

                        if (checkResponse.ok) {
                            const data = await checkResponse.json();
                            if (data.hasCard) {
                                this.showNotification('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∞. –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∫–∞—Ä—Ç–æ—á–∫—É.', 'error');
                                this.showAlreadyHaveCard();
                                return;
                            }
                        }
                    }

                    // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ
                    let photoUrl = '/images/default.jpg';
                    const photoInput = document.getElementById('add-photo-input');
                    const photoUrlInput = document.getElementById('add-photo-url');

                    if (photoInput && photoInput.files[0]) {
                        photoUrl = photoUrlInput.value;
                    }

                    const studentData = {
                        name: form.querySelector('#name').value.trim(),
                        institution: form.querySelector('#institution').value.trim(),
                        course: parseInt(form.querySelector('#course').value),
                        status: form.querySelector('#status').value,
                        description: form.querySelector('#description').value.trim(),
                        fullInfo: form.querySelector('#full-info').value.trim() || form.querySelector('#description').value.trim(),
                        skills: form.querySelector('#skills').value.split(',').map(s => s.trim()).filter(s => s),
                        links: {
                            github: form.querySelector('#github').value.trim() || null,
                            portfolio: form.querySelector('#portfolio').value.trim() || null
                        },
                        photo: photoUrl
                    };

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                    if (!studentData.institution) {
                        this.showNotification('–ü–æ–ª–µ "–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
                        return;
                    }

                    const response = await fetch('/api/students', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(studentData)
                    });

                    if (response.ok) {
                        const newStudent = await response.json();
                        this.showNotification('–ö–∞—Ä—Ç–æ—á–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');

                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏:', error);
                    this.showNotification(error.message, 'error');
                }
            }

            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            showLoginModal() {
                this.closeAllModals();

                const modalHTML = `
                    <div class="modal-overlay active" id="login-modal">
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <h3><i class="fas fa-sign-in-alt"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                                <button class="modal-close" onclick="window.addStudentSystem.closeModal('login-modal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 20px;">
                                    <small style="color: #666; display: block; margin-bottom: 10px;">–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</small>
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                                        <div><strong>–ê–¥–º–∏–Ω:</strong> admin / admin123</div>
                                        <div><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> student1 / student123</div>
                                    </div>
                                </div>
                                <form id="modal-login-form">
                                    <div class="form-group">
                                        <label>–õ–æ–≥–∏–Ω</label>
                                        <input type="text" id="modal-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label>–ü–∞—Ä–æ–ª—å</label>
                                        <input type="password" id="modal-password" required>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="window.addStudentSystem.closeModal('login-modal')">
                                            –û—Ç–º–µ–Ω–∞
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.style.overflow = 'hidden';

                const loginForm = document.getElementById('modal-login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const username = document.getElementById('modal-username').value;
                        const password = document.getElementById('modal-password').value;
                        this.login(username, password);
                    });
                }
            }

            showRegisterModal() {
                this.closeAllModals();

                const modalHTML = `
                    <div class="modal-overlay active" id="register-modal">
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <h3><i class="fas fa-user-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                                <button class="modal-close" onclick="window.addStudentSystem.closeModal('register-modal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="modal-register-form">
                                    <div class="form-group">
                                        <label>–õ–æ–≥–∏–Ω *</label>
                                        <input type="text" id="reg-username" required minlength="3">
                                        <small style="display: block; margin-top: 5px; color: #666;">–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</small>
                                    </div>
                                    <div class="form-group">
                                        <label>–ü–∞—Ä–æ–ª—å *</label>
                                        <input type="password" id="reg-password" required minlength="6">
                                        <small style="display: block; margin-top: 5px; color: #666;">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                        <input type="email" id="reg-email">
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="window.addStudentSystem.closeModal('register-modal')">
                                            –û—Ç–º–µ–Ω–∞
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.style.overflow = 'hidden';

                const registerForm = document.getElementById('modal-register-form');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const username = document.getElementById('reg-username').value;
                        const password = document.getElementById('reg-password').value;
                        const email = document.getElementById('reg-email').value;
                        this.register(username, password, email);
                    });
                }
            }

            async login(username, password) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        this.currentUser = await response.json();
                        this.updateUserInfo();
                        this.showNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
                        this.closeModal('login-modal');
                        await this.checkUserCard();
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                } catch (error) {
                    this.showNotification(error.message, 'error');
                }
            }

            async register(username, password, email) {
                try {
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            password,
                            email,
                            role: 'student'
                        })
                    });

                    if (response.ok) {
                        const user = await response.json();
                        this.showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'success');
                        this.closeModal('register-modal');
                        setTimeout(() => this.login(username, password), 1000);
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                    }
                } catch (error) {
                    this.showNotification(error.message, 'error');
                }
            }

            async logout() {
                try {
                    await fetch('/api/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    this.currentUser = null;
                    this.updateUserInfo();
                    this.showLoginSection();
                    this.showNotification('–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                }
            }

            openEditMyCard() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                window.location.href = '/';
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }

                const remainingModals = document.querySelectorAll('.modal-overlay');
                if (remainingModals.length === 0) {
                    document.body.style.overflow = 'auto';
                }
            }

            closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
                document.body.style.overflow = 'auto';
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É
        document.addEventListener('DOMContentLoaded', () => {
            window.addStudentSystem = new AddStudentSystem();
        });
    </script>
</body>
</html>